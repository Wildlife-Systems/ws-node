# WildlifeSystems
#
# This script is part of the WildlifeSystems project. For further information
# please refer to https://docs.wildlife.systems, or for more information on
# the project itself, please refer to https://wildlife.systems.

#Update system
apt-get update
apt-get install -y ufw jq

wget https://github.com/Wildlife-Systems/ws-node/raw/master/ws-heartbeat
chmod +x ws-heartbeat
chown root:root ws-heartbeat
mv ws-heartbeat /usr/bin
ws-heartbeat install

wget https://github.com/Wildlife-Systems/ws-node/raw/master/ws-setup
chmod +x ws-setup
chown root:root ws-setup
mv ws-setup /usr/bin

wget https://github.com/Wildlife-Systems/ws-node/raw/master/ws-run-audio
chmod +x ws-run-audio
chown root:root ws-run-audio
mv ws-run-audio /usr/bin

wget https://github.com/Wildlife-Systems/ws-node/raw/master/ws-indicate
chmod +x ws-indicate
chown root:root ws-indicate
mv ws-indicate /usr/bin

wget https://github.com/Wildlife-Systems/ws-node/raw/master/ws-network
chmod +x ws-network
chown root:root ws-network
mv ws-network /usr/bin

wget https://raw.githubusercontent.com/Wildlife-Systems/ws-node/master/os/all/audio.conf
OS="UNKNOWN"
OS_REPORTED=$(grep '^NAME=' /etc/os-release | cut -d '"' -f 2)
if [[ "$OS_REPORTED" == "Debian GNU/Linux" ]]; then
        OS="Debian"
        if [[ -f "/etc/apt/sources.list.d/raspi.list" ]]; then
                OS="Raspbian"
        fi
else
        if [[ "$OS_REPORTED" == "Ubuntu" ]]; then
                OS="Ubuntu"
                wget https://github.com/Wildlife-Systems/ws-node/raw/master/os/ubuntu/etc/ws
                chown root:root ws
                chmod 440 ws
                mv ws /etc/sudoers.d
        fi
fi
#CONF=$(jq --arg os $OS '.+{os:$os}' audio.conf)
#echo "$CONF" > audio.conf

# Check if /etc/ws exists and create it if not
if [[ ! -d "/etc/ws" ]]; then
  mkdir /etc/ws
fi

# Ask whether to override /etc/ws/ws.conf if it exists
if [[ -f "/etc/ws/audio.conf" ]]; then
  echo "File /etc/ws/audio.conf already exists. Do you want to override it? (y/n)"
  read OVERWRITE
  if [[ "$OVERWRITE" == "y" ]]; then
    mv audio.conf /etc/ws/audio.conf
  fi
else
  mv audio.conf /etc/ws/audio.conf
fi


if [[ "$OS_REPORTED" == "Ubuntu" ]]; then
  #Install raspi-config
  apt-get install raspi-config -y

  #Need to install whois package to get mkpasswd
  apt-get install whois
fi

#Install the abstraction layers
wget -O - https://raw.githubusercontent.com/Wildlife-Systems/sensor-control/main/install | sudo bash
wget -O - https://github.com/wildlife-systems/sound-device-control/raw/master/install | sudo bash
wget -O - https://github.com/Wildlife-Systems/image-device-control/raw/master/install | sudo bash
wget -O - https://github.com/wildlife-systems/pi-pwr/raw/master/install | sudo bash

if [[ "$1" == "unattended" ]]; then
  exit 0;
fi

echo $""
echo "Please run ws-setup to configure this node."
